"""
Author: Bhavya papudeshi
Aim:A snakemake workflow to assemble metagenome-assembled genomes
Step 1 - add the reads to the directory reads/
	The script makes an assumption that that reads are paired end 
	the extension to the reads should be fastq , NOT fq or gz
	The filename for forward reads should follow the syntax {sample name}_R1.fastq
	and reverse reads should follow the syntax {sample name}_R2.fastq

Run: snakemake  -s snakemake-cross-assembly -p 
The script runs the steps

Assembly - megahit
Assembly stats - quast 
Binning - metabat2
Binning stats - checkm 
Bin contrib- bowtie2
"""
import os
from os.path import join
import glob 

#getting the read names
# In the future fix this so compressed formats are allowed as well and fasta formats
SAMPLES, =glob_wildcards("reads/{sample}_R1.fastq")
if len(SAMPLES) == 0:
	sys.stderr.write(f"We did not find any fastq files in {SAMPLES}. Is this the right read dir?\n")
	sys.exit(0)
print(f"Samples are {SAMPLES}")

rule all:
	input:
		"assembly/megahit-assembly/final.contigs.fa",
		"assembly/megahit-quast/report.tsv",
		"binning/megahit-bowtie2-index.1.bt2",
		expand("binning/{sample}.bam", sample=SAMPLES),
		expand ("binning/{sample}.sam", sample=SAMPLES),
		"binning/metabat_depth",
		"binning/metabat_bins/metabat_bins.1.fa",
		"binning/checkm_summary",
		"metabat_bin_names.txt",
		"sample_list.txt",
		"contrib/metabat_bins.1.fa-index.1.bt2",
		"contrib/done",
		"contrib/bowtie2_alignment_rate.txt",
		"contrib/bowtie2_alignment_rate.tsv"

rule megahit:
	input:
		left="reads/left.fastq",
		right="reads/right.fastq"
	output:
		"assembly/megahit-assembly/final.contigs.fa",
		"assembly/megahit-assembly/log",
	params:
		odir="assembly/megahit-assembly"
	shell:
		"rmdir {params.odir}; megahit -1 {input.left} -2 {input.right} -o {params.odir} -t 16"

rule quast:
	input:
		"assembly/megahit-assembly/final.contigs.fa"
	params:
		odir="assembly/megahit-quast"
	output:
		"assembly/megahit-quast/report.tsv"
	shell:
		"quast.py {input} -o {params.odir}"

rule bowtie2Build:
	input:
		"assembly/megahit-assembly/final.contigs.fa"
	params:
		basename="binning/megahit-bowtie2-index"
	output:
		output1="binning/megahit-bowtie2-index.1.bt2",
		output2="binning/megahit-bowtie2-index.2.bt2",
		output3="binning/megahit-bowtie2-index.3.bt2",
		output4="binning/megahit-bowtie2-index.4.bt2",
		outputrev1="binning/megahit-bowtie2-index.rev.1.bt2",
		outputrev2="binning/megahit-bowtie2-index.rev.2.bt2"
	shell:
		"bowtie2-build {input} {params.basename}"

rule samfiles:
	input:
		un="binning/megahit-bowtie2-index.1.bt2",
		freads="reads/{sample}_R1.fastq",
		rreads="reads/{sample}_R2.fastq"
	output:
		reads_sam="binning/{sample}.sam"
	shell:
		"bowtie2 -x binning/megahit-bowtie2-index -1 {input.freads} -2 {input.rreads} -S {output.reads_sam} -p 16"

rule bamfiles:
	input:
		"binning/{sample}.sam"
	output:
		"binning/{sample}.bam"
	shell:
		"samtools view -bS {input} | samtools sort -o {output}"

rule metabat_contigs_depth:
	input:
		bam=expand("binning/{sample}.bam", sample=SAMPLES),
		contigs="assembly/megahit-assembly/final.contigs.fa"
	output:
		depth="binning/metabat_depth",
	run:
		shell("jgi_summarize_bam_contig_depths --outputDepth {output.depth} {input.bam}"),

rule metabat_bins:
	input:
		contigs="assembly/megahit-assembly/final.contigs.fa",
		depth="binning/metabat_depth"
	output:
		"binning/metabat_bins/metabat_bins.1.fa"
	params:
		basename="binning/metabat_bins/metabat_bins"
	shell:
		"""
		if [ -d "binning/metabat_bins" ]
		then
			metabat2 -i {input.contigs} -a {input.depth} -m 1500 -o {params.basename}
		else
			mkdir {params.basename}
			metabat2 -i {input.contigs} -a {input.depth} -m 1500 -o {params.basename}
		fi
		"""

rule checkm_tree:
	input:
		bins="binning/metabat_bins/metabat_bins.1.fa"
	params:
		base="binning/metabat_bins"
	output:
		"binning/checkm_summary"
	run:
		shell("checkm tree -r -x fa {params.base} binning/checkm_tree"),
		shell("checkm tree_qa binning/checkm_tree -f binning/checkm_tree_qa"),
		shell("checkm lineage_set binning/checkm_tree binning/checkm_marker"),
		shell("checkm analyze binning/checkm_marker -x fa {params.base} binning/checkm_analyze"),
		shell("checkm qa binning/checkm_marker binning/checkm_analyze > {output}"),

rule list_bins:
	input:
		chkpnt="binning/checkm_summary"
	output:
		"metabat_bin_names.txt"
	run:
		shell("if [-d 'contrib']; then  ls binning/metabat_bins/*.fa >{output}; else mkdir contrib; ls binning/metabat_bins/*.fa >{output}; fi"),
		shell("sed -i 's|binning/metabat_bins/||g' {output}")

rule list_samples:
	input:
		chkpnt="metabat_bin_names.txt"
	output:
		"sample_list.txt"
	run:
		shell("ls reads/*R1.fastq > {output}"),
		shell("sed -i 's/_R1.fastq//g' {output}"),
		shell("sed -i 's|reads/||g' {output}")

rule bins_bowtie2_index:
	input:
		"metabat_bin_names.txt"
	output:
		"contrib/metabat_bins.1.fa-index.1.bt2"
	run:
		shell("for f in `cat {input}`; do bowtie2-build binning/metabat_bins/$f contrib/$f-index; done")

rule bins_maps_reads:
	input:
		bin_list="metabat_bin_names.txt",
		sample_list="sample_list.txt",
		ind="contrib/metabat_bins.1.fa-index.1.bt2"
	output:
		"contrib/done"
	threads: 10
	shell:
		"""
		for i in `cat {input.bin_list}`; do for f in `cat {input.sample_list}`; do bowtie2 -x contrib/"$i"-index -1 reads/"$f"_R1.fastq -2 reads/"$f"_R2.fastq -p {threads} -S contrib/"$f"_"$i".sam 2>contrib/"$f"_"$i".log; done ; done
		touch contrib/done
		"""

rule fomat_contrib:
	input:
		chkpnt="contrib/done"
	output:
		o="contrib/bowtie2_alignment_rate.txt",
		final="contrib/bowtie2_alignment_rate.tsv"
	run:
		shell("for f in contrib/*.log; do grep 'overall alignment rate' $f && echo $f; done >> {output.o}"),
		shell("sed -i 's/overall alignment rate//g' {output.o}"),
		shell("""xargs -n2 <{output.o} > {output.final}"""),
		shell("sed -i 's|contrib/||g' {output.final}"),
		shell("sed -i 's/_good_out_/ /g' {output.final}")
