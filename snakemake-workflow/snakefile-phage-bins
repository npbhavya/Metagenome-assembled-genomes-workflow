"""
Author: Bhavya papudeshi
Aim:A snakemake workflow that refines the MAGs as phage genomes 
	Method - reads the metabat2 bins and run viral_verify to prefict the "Virus" bins 
		selects the "Virus" sequences to a new file
		calculate the viral completensss of each bin

Run: snakemake  -s snakemake-phage-bins --cores all
"""

import os
from os.path import join
import glob

#getting the read names
# In the future fix this so compressed formats are allowed as well and fasta formats
BINS, =glob_wildcards("binning/metabat_bins/{bin}.fa")
if len(BINS) == 0:
	sys.stderr.write(f"We did not find any MAGs in {BINS}. Confirm if the MAGs were assembled?\n")
	sys.exit(0)

print(f"Bins are {BINS}")

#lists all the outputs generated by the workflow
rule all:
	input:
		expand("binning/{bin}_viral_verify", bin=BINS),
		expand("binning/{bin}-viralseq.txt", bin=BINS),
		expand("binning/{bin}-viralseq.fasta", bin=BINS),
		expand("binning/{bin}-viralComplete/completeness.tsv", bin=BINS),
		expand("binning/{bin}-viralComplete/completeness2.tsv", bin=BINS),
		"binning/phage_completeness.tsv"

rule viral_verify:
	input:
		input="binning/metabat_bins/{bin}.fa"
	output:
		directory("binning/{bin}_viral_verify")
	params:
		"binning/{bin}_viral_verify/{bin}-results.csv"
	shell:
		"""
		set +e
		viral_verify -i {input.input} -o {output} -H ~/Pfam-A.hmm -t 10
		exitcode=$?
		if [ $exitcode != 25 ]
		then
			mkdir {output}
			touch {params}
			exit 0
		fi
		"""

rule get_viral_seq:
	input:
		i="binning/{bin}_viral_verify"
	params:
		bi="{bin}-results.csv"
	output:
		"binning/{bin}-viralseq.txt"
	shell:
		"""
		set +e
		grep -w 'Virus,' {input.i}/{params.bi} | cut -d ',' -f 1 >{output}
		exitcode=$?
		if [ $exitcode != 0 ]
		then
			touch  {output}
			exit 0
		fi
		"""

rule samtools_faidx:
	input:
		contigs="binning/{bin}-viralseq.txt",
		metabat_bins="binning/metabat_bins/{bin}.fa"
	output:
		"binning/{bin}-viralseq.fasta"
	shell:
		"""
		set +e
		for f in `cat {input.contigs}`; do samtools faidx {input.metabat_bins} $f >> {output}; done
		if [[ ! -f {output} ]]
		then
			touch {output}
			exit 0
		fi
		"""

rule checkv:
	input:
		"binning/{bin}-viralseq.fasta"
	params:
		"binning/{bin}-viralComplete"
	output:
		"binning/{bin}-viralComplete/completeness.tsv"
	shell:
		"""
		set +e
		export CHECKVDB=~/checkv-db-v1.0
		checkv completeness {input} {params} -t 10
		exitcode=$?
		if [[ ! -d {output} ]]
		then
			mkdir {params}
			touch {output}
			exit 0
		fi
		"""

rule checkv_output:
	input:
		"binning/{bin}-viralComplete/completeness.tsv"
	output:
		"binning/{bin}-viralComplete/completeness2.tsv"
	shell:
		"""
		set +e
		sed 's|.*|{input},&|g' {input} > {output}
		exitcode=$?
		if [ $exitcode == 25 ]
		then
			touch {output}
			exit 0
		fi
		"""

rule final_results:
	input:
		expand("binning/{bin}-viralComplete/completeness2.tsv", bin=BINS)
	output:
		"binning/phage_completeness.tsv"
	shell:
		"cat {input}> {output}"
